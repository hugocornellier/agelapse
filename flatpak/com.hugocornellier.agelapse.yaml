app-id: com.hugocornellier.agelapse
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: agelapse

finish-args:
  # Display - Wayland preferred, X11 fallback
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc

  # GPU access for video rendering and OpenGL
  - --device=dri

  # Camera/webcam access for photo capture
  - --device=all

  # Network access (for future updates, help links)
  - --share=network

  # Filesystem access for importing/exporting photos and videos
  - --filesystem=xdg-pictures:ro
  - --filesystem=xdg-videos:rw
  - --filesystem=xdg-download:rw

  # Desktop integration
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.FileManager1

  # Screen saver inhibition during video export
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.gnome.SessionManager

# FFmpeg extension for video encoding
add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    version: '24.08'
    add-ld-path: .
    autodelete: false

cleanup:
  - /include
  - /lib/pkgconfig
  - /lib/cmake
  - '*.a'
  - '*.la'

modules:
  # === MPV DEPENDENCIES ===

  - name: python3-jinja2
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app --no-deps jinja2-3.1.6-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/62/a1/3d680cbfd5f4b8f15abc1d571870c5fc3e594bb582bc3b64ea099db13e56/jinja2-3.1.6-py3-none-any.whl
        sha256: 85ece4451f492d0c13c5dd7c13a64681a86afae63a5f347908daf103ce6d2f67

  - name: libass
    buildsystem: autotools
    config-opts:
      - --disable-static
    sources:
      - type: archive
        url: https://github.com/libass/libass/releases/download/0.17.1/libass-0.17.1.tar.xz
        sha256: f0da0bbfba476c16ae3e1cfd862256d30915911f7abaa1b16ce62ee653192784

  - name: libplacebo
    buildsystem: meson
    config-opts:
      - --libdir=/app/lib
      - -Dvulkan=enabled
      - -Dshaderc=enabled
      - -Dopengl=disabled
      - -Dd3d11=disabled
      - -Ddemos=false
      - -Dtests=false
    sources:
      - type: archive
        url: https://code.videolan.org/videolan/libplacebo/-/archive/v6.338.2/libplacebo-v6.338.2.tar.gz
        sha256: d029adbe55bba8aed7aed2c48b0b66081dddfb9d42683a709342e33aa666c544

  - name: mpv
    buildsystem: meson
    config-opts:
      - --libdir=/app/lib
      - -Dlibmpv=true
      - -Dcplayer=false
      - -Dbuild-date=false
      - -Dalsa=disabled
      - -Dmanpage-build=disabled
      - -Dlua=disabled
      - -Djavascript=disabled
      - -Dpulse=disabled
      - -Djack=disabled
      - -Dpipewire=disabled
    sources:
      - type: archive
        url: https://github.com/mpv-player/mpv/archive/refs/tags/v0.39.0.tar.gz
        sha256: 2ca92437affb62c2b559b4419ea4785c70d023590500e8a52e95ea3ab4554683

  # === AGELAPSE APP ===

  - name: agelapse
    buildsystem: simple
    build-commands:
      # Create directory for ffmpeg extension mount point
      - mkdir -p /app/lib/ffmpeg

      # Install the Flutter bundle
      - cp -r bundle/* /app/
      - chmod +x /app/agelapse

      # Install wrapper script that sets up environment
      - install -Dm755 agelapse.sh /app/bin/agelapse

      # Install desktop file
      - install -Dm644 com.hugocornellier.agelapse.desktop /app/share/applications/com.hugocornellier.agelapse.desktop

      # Install icons (multiple sizes for different contexts)
      - install -Dm644 icons/256x256/agelapse.png /app/share/icons/hicolor/256x256/apps/com.hugocornellier.agelapse.png
      - install -Dm644 icons/128x128/agelapse.png /app/share/icons/hicolor/128x128/apps/com.hugocornellier.agelapse.png
      - install -Dm644 icons/64x64/agelapse.png /app/share/icons/hicolor/64x64/apps/com.hugocornellier.agelapse.png

      # Install metainfo for app store listings
      - install -Dm644 com.hugocornellier.agelapse.metainfo.xml /app/share/metainfo/com.hugocornellier.agelapse.metainfo.xml

      # Install license file (required by Flathub)
      - install -Dm644 LICENSE /app/share/licenses/com.hugocornellier.agelapse/LICENSE

    sources:
      # Pre-built Flutter bundle (you build this with: flutter build linux --release)
      - type: dir
        path: bundle
        dest: bundle

      # Wrapper script
      - type: file
        path: agelapse.sh

      # Desktop entry
      - type: file
        path: com.hugocornellier.agelapse.desktop

      # Icons
      - type: dir
        path: icons
        dest: icons

      # App metadata
      - type: file
        path: com.hugocornellier.agelapse.metainfo.xml

      # License file
      - type: file
        path: ../LICENSE
